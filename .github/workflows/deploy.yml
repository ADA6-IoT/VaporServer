  name: Deploy to EC2

  on:
    push:
      branches: [ main ]
    workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ê²Œ

  jobs:
    deploy:
      name: Deploy to EC2
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Deploy to EC2 via SSH
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_SSH_KEY }}
            port: 22
            script: |
              cd ~/AppleAcademyChallenge6_Vapor

              echo "ğŸ“¥ Pulling latest code..."
              git pull origin main

              echo "ğŸ›‘ Stopping existing containers..."
              docker-compose down

              echo "ğŸ”¨ Building Docker images..."
              docker-compose build --no-cache

              echo "ğŸš€ Starting services..."
              docker-compose up -d

              echo "ğŸ“Š Running migrations..."
              docker-compose run --rm migrate

              echo "âœ… Deployment completed!"

              echo "ğŸ“‹ Service status:"
              docker-compose ps